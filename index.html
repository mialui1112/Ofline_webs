<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tổng hợp AI</title>
  <meta name="description" content="Danh sách AI" />
  <link id="site-favicon" rel="icon" href="./assets/favicon.png" type="image/png">
  <meta name="site-favicon" content="">
  <style>
    :root {
      --bg: #070812;
      --panel: #0c0f19;
      --panel-2: #121828;
      --text: #eaf0ff;
      --muted: #9fb0d0;
      --brand: #8ca7ff;
      --ring: rgba(140, 167, 255, .35);
      --card: #0a0f1a;
      --border: rgba(255, 255, 255, .08);
      --shadow: 0 12px 40px rgba(0, 0, 0, .55);
      --radius: 18px;
      --radius-sm: 12px;
      --gap: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --grid: 300px;
      --nebula-1: radial-gradient(1100px 700px at 120% -10%, rgba(140, 167, 255, .18), transparent 60%);
      --nebula-2: radial-gradient(900px 600px at -10% 120%, rgba(56, 189, 248, .16), transparent 55%);
      --nebula-3: radial-gradient(800px 500px at 20% -20%, rgba(34, 197, 94, .14), transparent 60%);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f8ff;
        --panel: #ffffff;
        --panel-2: #f3f6ff;
        --text: #0b1220;
        --muted: #5d6a86;
        --card: #ffffff;
        --border: rgba(11, 18, 32, .09);
        --shadow: 0 12px 40px rgba(16, 24, 40, .08);
        --nebula-1: radial-gradient(1100px 700px at 120% -10%, rgba(140, 167, 255, .28), transparent 60%);
        --nebula-2: radial-gradient(900px 600px at -10% 120%, rgba(56, 189, 248, .22), transparent 55%);
        --nebula-3: radial-gradient(800px 500px at 20% -20%, rgba(34, 197, 94, .20), transparent 60%);
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font: 15px/1.65 var(--font);
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
    }

    /* ======= Nebulae background ======= */
    .bg {
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        var(--nebula-1),
        var(--nebula-2),
        var(--nebula-3),
        radial-gradient(1200px 900px at 50% -30%, rgba(99, 102, 241, .12), transparent 60%),
        radial-gradient(1200px 900px at 50% 130%, rgba(20, 184, 166, .10), transparent 60%);
      animation: drift 26s ease-in-out infinite alternate;
      will-change: background-position;
    }

    @keyframes drift {
      0% {
        background-position: 0 0, 0 0, 0 0, 0 0, 0 0
      }

      100% {
        background-position: 30px -40px, -45px 30px, 25px 20px, 15px -15px, -20px 10px
      }
    }

    /* Subtle starfield canvas */
    canvas#nebula-canvas {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      opacity: .5;
      /* có thể 0.4–0.6 */
      mix-blend-mode: screen;
      /* Không dùng blur/drop-shadow để tránh lag */
    }

    @media (prefers-reduced-motion: reduce) {
      .bg {
        animation: none
      }

      canvas#nebula-canvas {
        display: none
      }
    }

    .wrap {
      max-width: 1160px;
      margin: 40px auto;
      padding: 0 18px
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background:
        conic-gradient(from 210deg, #8ca7ff, #22c55e, #60a5fa, #8ca7ff);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
      box-shadow: var(--shadow);
    }

    h1 {
      margin: 0;
      font-size: clamp(20px, 3vw, 30px)
    }

    .sub {
      color: var(--muted);
      margin-top: 4px;
      font-size: 13px
    }

    .tools {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .search {
      position: relative;
      flex: 1 1 380px;
      min-width: 220px
    }

    .search input {
      width: 100%;
      padding: 12px 44px 12px 40px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .03), transparent), var(--panel);
      color: var(--text);
      outline: none;
      box-shadow: 0 1px 0 rgba(255, 255, 255, .03) inset, var(--shadow)
    }

    .search input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 6px var(--ring), var(--shadow)
    }

    .search .ico {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: .7;
      font-size: 16px;
      font-family: var(--mono)
    }

    .chip {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent), var(--panel);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      backdrop-filter: blur(6px);
    }

    /* Tag filter bar */
    .tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px
    }

    .tag {
      padding: 8px 12px;
      border-radius: 9999px;
      border: 1px solid var(--border);
      cursor: pointer;
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent), var(--panel);
      color: var(--muted);
      font-size: 12px;
      user-select: none;
      transition: all .18s;
    }

    .tag.active {
      color: var(--text);
      border-color: rgba(140, 167, 255, .6);
      box-shadow: 0 0 0 4px var(--ring)
    }

    .tag .count {
      opacity: .7;
      margin-left: 6px;
      font-variant-numeric: tabular-nums
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--grid), 1fr));
      gap: var(--gap);
      margin-top: 18px
    }

    .card {
      position: relative;
      display: flex;
      gap: 14px;
      align-items: flex-start;
      padding: 16px;
      text-decoration: none;
      color: inherit;
      cursor: pointer;
      background:
        linear-gradient(180deg, rgba(255, 255, 255, .03), transparent 40%),
        radial-gradient(60% 100% at 110% 10%, rgba(140, 167, 255, .06), transparent 60%),
        var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: none;
      transition: transform .18s, box-shadow .18s, border-color .18s;
      overflow: hidden;
      will-change: transform;
    }

    .card:hover {
      transform: translateY(-4px) scale(1.012);
      border-color: rgba(140, 167, 255, .5);
      box-shadow: var(--shadow)
    }

    .card:focus-visible {
      outline: none;
      box-shadow: 0 0 0 8px var(--ring), var(--shadow)
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: calc(var(--radius)+1px);
      padding: 1px;
      background: linear-gradient(120deg, rgba(140, 167, 255, .6), rgba(34, 197, 94, .4), rgba(99, 102, 241, .5)) border-box;
      -webkit-mask: linear-gradient(#000 0 0) padding-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity .25s
    }

    .card:hover::before {
      opacity: .55
    }

    .fav {
      width: 46px;
      height: 46px;
      border-radius: 12px;
      background: var(--panel-2);
      display: grid;
      place-items: center;
      flex: 0 0 auto;
      overflow: hidden;
      border: 1px solid var(--border)
    }

    .fav img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .fav .placeholder {
      font-weight: 800;
      font-size: 14px;
      color: var(--muted)
    }

    .meta {
      flex: 1;
      min-width: 0
    }

    .title {
      margin: 0 0 6px 0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .2px
    }

    .title mark {
      background: transparent;
      color: inherit;
      position: relative
    }

    .title mark::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 2px;
      height: 10px;
      border-radius: 6px;
      background: rgba(140, 167, 255, .22);
      z-index: -1
    }

    .note {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px
    }

    .badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }

    .badge {
      font-size: 11px;
      color: var(--muted);
      border: 1px dashed var(--border);
      padding: 4px 8px;
      border-radius: 999px
    }

    .nebula-text {
      background: linear-gradient(120deg, #8ca7ff, #38bdf8, #c522af, #60a5fa, #8ca7ff);
      background-size: 240% 240%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: nebulaShift 10s ease-in-out infinite alternate;
      /* chậm hơn */
    }

    @media (prefers-reduced-motion: reduce) {
      .nebula-text {
        animation: none;
      }
    }

    @keyframes nebulaShift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex: 0 0 auto
    }

    .btn {
      display: inline-grid;
      place-items: center;
      width: 30px;
      height: 30px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      transition: all .18s;
      color: var(--muted)
    }

    .btn:hover {
      border-color: rgba(140, 167, 255, .5);
      color: var(--text)
    }

    .footer {
      margin-top: 26px;
      padding-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--border)
    }

    #raw-links {
      display: none
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 40px 10px;
      border: 1px dashed var(--border);
      border-radius: var(--radius-sm);
      display: none
    }

    a,
    button,
    input {
      -webkit-tap-highlight-color: transparent
    }
  </style>
</head>

<body>
  <!-- Nebulae background -->
  <div class="bg" aria-hidden="true"></div>
  <canvas id="nebula-canvas" aria-hidden="true"></canvas>

  <div class="wrap">
    <header>
      <a class="brand" href="#" aria-label="Trang chủ" data-icon="https://i.postimg.cc/6p7L5CDs/main.png">
        <div class="logo" aria-hidden="true">AI</div>
        <div>
          <h1 class="nebula-text">Trang chủ</h1>
          <div class="sub">Danh sách các Website về AI</div>
        </div>
      </a>
      <div style="flex:1"></div>
      <div class="tools">
        <div class="search">
          <span class="ico">⌕</span>
          <input id="q" type="search" placeholder="Tìm theo tên, ghi chú hoặc tag…" autocomplete="off" />
        </div>
        <div class="chip" id="count">0 site</div>
      </div>
    </header>

    <div class="tags" id="tagbar" aria-label="Bộ lọc theo tag"></div>

    <section id="cards" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty">Không tìm thấy kết quả phù hợp.</div>

    <div class="footer">
      <div>Đây là bản Clone, không dựa vào bản gốc.</div>
      <div>Gợi ý: nhấn <span style="font-family:var(--mono)">Esc</span> để xoá.</div>
    </div>

    <!-- NGUỒN DỮ LIỆU: thêm link tại đây. Ghi chú tùy chỉnh bằng data-note -->
    <ul id="raw-links">
      <li>
        <a href="./offline_sites/role-verse.vercel.app/role-verse.vercel.app/index.html"
          data-note="Nhập vai nhân vật cùng Ai với cấu hình đầy đủ, đẹp"
          data-icon="https://i.postimg.cc/Rh4Fr0rx/z6715421803152-da37eaa2f76944a1397bb679b27802dc.jpg">
          AI Nhập vai Pre
        </a>
      </li>
      <li>
        <a href="./offline_sites/role-verse-lite-chester.netlify.app/role-verse-lite-chester.netlify.app/index.html"
          data-note="Nhập vai nhân vật cùng Ai với cấu hình nhẹ, mượt"
          data-icon="https://i.postimg.cc/Rh4Fr0rx/z6715421803152-da37eaa2f76944a1397bb679b27802dc.jpg">
          AI Nhập vai
        </a>
      </li>
      <li>
        <a href="./offline_sites/[1.2.0-beta-fix].ai-sang-tac-truyen-120beta.netlify.app/ai-sang-tac-truyen-120beta.netlify.app/index.html"
          data-note="Sửa lại ô nhập nhân vật chính. Thêm nút mở rộng cho định hướng cốt truyện"
          data-icon="./offline_sites/[1.2.0-beta-fix].ai-sang-tac-truyen-120beta.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 1.2.0 [beta-HotFix]
        </a>
      </li>
      <li>
        <a href="./offline_sites/[1.2.0-beta].ai-sang-tac-truyen-120beta.netlify.app/ai-sang-tac-truyen-120beta.netlify.app/index.html"
          data-note="NFSW viết dài hơn, fix vài lỗi nhỏ."
          data-icon="./offline_sites/[1.2.0-beta].ai-sang-tac-truyen-120beta.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 1.2.0 [beta]
        </a>
      </li>
      <li>
        <a href="./offline_sites/[1.1.9.v2].ai-sang-tac-truyen.netlify.app/ai-sang-tac-truyen.netlify.app/index.html"
          data-note="Sửa lỗi Prompt NFSW."
          data-icon="./offline_sites/[1.1.9.v2].ai-sang-tac-truyen.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 1.1.9 [v2]
        </a>
      </li>
      <li>
        <a href="./offline_sites/[1.1.9.v1].ai-sang-tac-truyen-v1.netlify.app/ai-sang-tac-truyen-v1.netlify.app/index.html"
          data-note="Sửa lỗi Prompt NFSW và ít cảnh báo bộ lọc"
          data-icon="./offline_sites/[1.1.9.v1].ai-sang-tac-truyen-v1.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 1.1.9 [v1]
        </a>
      </li>
      <li>
        <a href="./offline_sites/[1.1.7].ai-sang-tac-truyen-ver117.netlify.app/ai-sang-tac-truyen-ver117.netlify.app/index.html"
          data-note="Tăng cường chức năng load txt đồng nhân. Thêm giọng văn cho nhân vật (mới chỉ là ý tưởng). Sửa lỗi Fobidden qua Proxy"
          data-icon="./offline_sites/[1.1.7].ai-sang-tac-truyen-ver117.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 1.1.7
        </a>
      </li>
      <li>
        <a href="./offline_sites/[1.1.2].ai-sang-tac-truyen-ver-cu.netlify.app/ai-sang-tac-truyen-ver-cu.netlify.app/index.html"
          data-note="Cải tiến hiệu năng và ổn định, sửa một số lỗi nhỏ"
          data-icon="./offline_sites/[1.1.2].ai-sang-tac-truyen-ver-cu.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 1.1.2
        </a>
      </li>
      <li>
        <a href="./offline_sites/[0.0.0].ai-sang-tac-truyen-ver000.netlify.app/ai-sang-tac-truyen-ver000.netlify.app/index.html"
          data-note="Phiên bản sơ khai"
          data-icon="./offline_sites/[0.0.0].ai-sang-tac-truyen-ver000.netlify.app/ntk918.github.io/my-images/dragon_light.webp">
          AI Sáng Tác Truyện - 0.0.0
        </a>
      </li>
    </ul>
  </div>

  <script>
    (function () {
      const $ = (s, d = document) => d.querySelector(s);
      const $$ = (s, d = document) => Array.from(d.querySelectorAll(s));
      const raw = $$('#raw-links a');
      const cards = $('#cards');
      const q = $('#q');
      const chip = $('#count');
      const empty = $('#empty');
      const tagbar = $('#tagbar');

      // ===== Starfield (ultra-light, fade in/out + respawn) =====
      const canvas = document.getElementById('nebula-canvas');
      const ctx = canvas.getContext('2d', { alpha: true });

      // Tùy chỉnh nhanh
      const STAR_MAX_COUNT = 70;         // tổng số sao (40–100 là hợp lý)
      const TARGET_FPS = 30;             // throttling về ~30fps
      const DPR_CLAMP = 1.0;             // để 1.0 cho nhẹ; tăng 1.5–2.0 nếu muốn sắc nét hơn
      const LIFE_MIN = 2.2;              // giây
      const LIFE_MAX = 5.0;              // giây
      const R_MIN = 0.4;                 // bán kính
      const R_MAX = 1.1;
      const TWINKLE_MIN = 0.3;           // biên độ nhấp nháy (0..1)
      const TWINKLE_MAX = 0.65;
      const MOVE_SPEED = 0.02;           // px/ms (rất nhỏ để gần như đứng yên)

      let stars = [];
      let rafId = null;
      let lastTs = 0;
      let paused = false;

      function rand(a, b) { return a + Math.random() * (b - a); }

      function makeStar(w, h) {
        // khởi tạo 1 sao với vòng đời fade in/out
        const life = rand(LIFE_MIN, LIFE_MAX) * 1000; // ms
        return {
          x: Math.random() * w,
          y: Math.random() * h,
          r: rand(R_MIN, R_MAX),
          // twinkle: modulate alpha nhẹ nhàng
          twA: rand(TWINKLE_MIN, TWINKLE_MAX),
          twW: rand(0.0012, 0.0024),   // tần số nhấp nháy (rad/ms)
          twP: Math.random() * Math.PI * 2, // pha ban đầu
          // life cycle
          t: rand(0, life), // tiến độ ngẫu nhiên để không đồng bộ
          life,
          // chuyển động rất chậm để tạo cảm giác hô hấp
          vx: rand(-MOVE_SPEED, MOVE_SPEED),
          vy: rand(-MOVE_SPEED, MOVE_SPEED),
        };
      }
      function resizeCanvas() {
        const dpr = Math.min(DPR_CLAMP, (window.devicePixelRatio || 1));
        const w = Math.floor(innerWidth);
        const h = Math.floor(innerHeight);
        canvas.width = Math.max(1, Math.floor(w * dpr));
        canvas.height = Math.max(1, Math.floor(h * dpr));
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        // tái tạo dàn sao với số lượng dựa theo diện tích (nhưng clamp tối đa)
        const area = w * h;
        const target = Math.min(STAR_MAX_COUNT, Math.max(20, Math.round(area / 45000)));
        stars = Array.from({ length: target }, () => makeStar(w, h));
      }

      function drawFrame(ts) {
        if (paused) return;
        if (!lastTs) lastTs = ts;
        const dt = ts - lastTs;

        // throttling ~30 FPS
        if (dt < (1000 / TARGET_FPS)) {
          rafId = requestAnimationFrame(drawFrame);
          return;
        }
        lastTs = ts;

        const w = canvas.clientWidth || innerWidth;
        const h = canvas.clientHeight || innerHeight;

        // clear nhẹ
        ctx.clearRect(0, 0, w, h);

        // vẽ theo batch để tránh long loop blocking
        for (let i = 0; i < stars.length; i++) {
          const s = stars[i];

          // update vòng đời & twinkle
          s.t += dt;
          if (s.t >= s.life) {
            stars[i] = makeStar(w, h);       // respawn
            continue;
          }
          const life01 = s.t / s.life;       // 0..1
          // fade in 30% đầu, fade out 30% cuối
          let fade = 1.0;
          if (life01 < 0.3) fade = life01 / 0.3;
          else if (life01 > 0.7) fade = (1 - life01) / 0.3;

          // nhấp nháy nhẹ
          const tw = (Math.sin(s.twP + ts * s.twW) + 1) * 0.5; // 0..1
          const twMix = 0.6 + s.twA * (tw - 0.5);              // khoảng ~0.3..0.9

          // alpha tổng hợp (nhỏ để mờ, tránh gắt)
          const alpha = Math.max(0, Math.min(1, 0.18 + 0.65 * fade * twMix));
          ctx.globalAlpha = alpha;

          // update di chuyển chậm (wrap-around biên)
          s.x += s.vx * dt;
          s.y += s.vy * dt;
          if (s.x < -2) s.x = w + 2; else if (s.x > w + 2) s.x = -2;
          if (s.y < -2) s.y = h + 2; else if (s.y > h + 2) s.y = -2;

          // vẽ
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          ctx.fillStyle = '#bcd3ff'; // giữ 1 màu để rẻ
          ctx.fill();
        }

        ctx.globalAlpha = 1;
        rafId = requestAnimationFrame(drawFrame);
      }

      // pause khi tab ẩn để tiết kiệm CPU/GPU
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          paused = true;
          if (rafId) cancelAnimationFrame(rafId);
          rafId = null;
        } else {
          paused = false;
          lastTs = 0;
          rafId = requestAnimationFrame(drawFrame);
        }
      });

      // tôn trọng reduce-motion: vẽ tĩnh 1 frame
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas, { passive: true });

      if (!prefersReduced) {
        rafId = requestAnimationFrame(drawFrame);
      } else {
        // chỉ render 1 lần tĩnh
        const w = canvas.clientWidth || innerWidth;
        const h = canvas.clientHeight || innerHeight;
        ctx.clearRect(0, 0, w, h);
        for (const s of stars) {
          ctx.globalAlpha = 0.25;
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          ctx.fillStyle = '#bcd3ff';
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      // ===== Utilities =====
      const norm = s => (s || '').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
      const LS_KEY = 'nebulae_notes_v1';

      const notesStore = {
        _map: (() => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch { return {}; } })(),
        get(href, fallback) { return this._map[href] ?? fallback ?? ''; },
        set(href, note) { this._map[href] = note; localStorage.setItem(LS_KEY, JSON.stringify(this._map)); }
      };

      const makeLetterIcon = letter => {
        const div = document.createElement('div');
        div.className = 'placeholder';
        div.textContent = (letter || '★').toUpperCase();
        return div;
      };

      function guessFavicon(href) {
        try {
          const u = new URL(href, location.href);
          // strip index.html and keep folder
          let p = u.pathname.replace(/index\.html?$/i, '');
          if (!p.endsWith('/')) p += '/';
          // Look for favicon.ico within the same snapshot folder
          return p + 'favicon.ico';
        } catch (e) { return null; }
      }

      function extractVersion(title) {
        const m = title.match(/-\s*([0-9]+(?:\.[0-9]+)*)(?:\s*(\[[^\]]+\]))?$/);
        if (!m) return null;
        return m[1] + (m[2] ? ' ' + m[2] : '');
      }

      // ===== Build data =====
      const data = raw.map(a => {
        const href = a.getAttribute('href');
        const title = (a.textContent || '').trim().replace(/\s+/g, ' ');
        const noteDefault = a.getAttribute('data-note') || '';
        const note = notesStore.get(href, noteDefault);
        const ver = extractVersion(title);
        const icon = a.getAttribute('data-icon') || '';
        const tags = [];
        if (/netlify/i.test(href) || /netlify/i.test(title)) tags.push('Netlify');
        if (/github/i.test(href)) tags.push('GitHub Pages');
        if (/vercel/i.test(href)) tags.push('Vercel');
        if (ver) tags.push('v' + ver.replace(/^v/i, ''));

        // 🔥 cache chuỗi chuẩn hoá 1 lần
        const titleNorm = norm(title);
        const noteNorm = norm(note);
        const tagsNorm = tags.map(t => norm(t));

        return { href, title, note, tags, ver, icon, titleNorm, noteNorm, tagsNorm };
      });

      // ===== Tag bar =====
      const allTags = Array.from(new Set(data.flatMap(d => d.tags))).sort((a, b) => a.localeCompare(b, 'vi'));
      let activeTag = null;

      // 👉 Chỉ dùng các provider, loại toàn bộ tag phiên bản (bắt đầu bằng "v" + số)
      const providerWhitelist = ['Netlify', 'GitHub Pages', 'Vercel'];
      let displayTags = allTags.filter(t => !/^v\d/i.test(t));                // bỏ version
      const whitelisted = displayTags.filter(t => providerWhitelist.includes(t));
      // nếu tìm được trong whitelist thì chỉ hiển thị whitelist; nếu không thì dùng displayTags (đã loại version)
      displayTags = whitelisted.length ? providerWhitelist.filter(p => whitelisted.includes(p)) : displayTags;

      function renderTags() {
        tagbar.innerHTML = '';
        const frag = document.createDocumentFragment();

        // Nút "Tất cả" — mặc định ACTIVE
        const btnAll = document.createElement('button');
        btnAll.type = 'button';
        btnAll.className = 'tag active';
        btnAll.textContent = 'Tất cả';
        const cAll = document.createElement('span'); cAll.className = 'count'; cAll.textContent = data.length;
        btnAll.appendChild(cAll);
        btnAll.addEventListener('click', () => {
          activeTag = null;
          // reset trạng thái active
          $$('.tag', tagbar).forEach(t => t.classList.remove('active'));
          btnAll.classList.add('active');
          applyFilter();
        });
        frag.appendChild(btnAll);

        // Chỉ render provider (đã loại version)
        displayTags.forEach(t => {
          const count = data.filter(d => d.tags.includes(t)).length;
          const el = document.createElement('button');
          el.type = 'button';
          el.className = 'tag';
          el.textContent = t;
          const c = document.createElement('span'); c.className = 'count'; c.textContent = count;
          el.appendChild(c);

          el.addEventListener('click', () => {
            if (activeTag === t) {
              // bấm lại cùng tag -> về "Tất cả"
              btnAll.click();
              return;
            }
            // chọn tag mới -> chỉ 1 tag active
            activeTag = t;
            $$('.tag', tagbar).forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            applyFilter();
          });

          frag.appendChild(el);
        });

        tagbar.appendChild(frag);
      }
      renderTags();


      // ===== Render cards =====
      const lazyIcos = new IntersectionObserver(entries => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            const img = e.target;
            img.src = img.dataset.src;
            lazyIcos.unobserve(img);
          }
        });
      }, { rootMargin: '200px' });

      function highlight(text, kw) {
        if (!kw) return text;
        const i = norm(text).indexOf(kw);
        if (i < 0) return text;
        const realSlice = (src, start, len) => {
          let cur = 0, out = '';
          for (const ch of src) {
            if (cur >= start && cur < start + len) out += ch;
            cur++;
            if (cur >= start + len) break;
          }
          return out;
        };
        // Approx fallback: just split by length (safe enough for most cases here)
        return text.slice(0, i) + '<mark>' + text.slice(i, i + kw.length) + '</mark>' + text.slice(i + kw.length);
      }
      function renderChunked(items, kw = '') {
        cards.innerHTML = '';
        if (!items.length) {
          empty.style.display = 'block'; chip.textContent = '0 site'; return;
        }
        empty.style.display = 'none';
        chip.textContent = items.length + (items.length > 1 ? ' sites' : ' site');

        const BATCH = 48;           // tuỳ ý 32–64
        let i = 0;
        function step() {
          const frag = document.createDocumentFragment();
          for (let c = 0; c < BATCH && i < items.length; c++, i++) {
            frag.appendChild(buildCard(items[i], kw)); // tách build DOM 1 card riêng
          }
          cards.appendChild(frag);
          if (i < items.length) requestAnimationFrame(step);
          else setupKeyboardNav(); // gọi lại khi xong
        }
        requestAnimationFrame(step);
      }

      function generateStaticPreview(src, w = 46, h = 46) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          // Với file local cùng origin thì OK; nếu khác origin, có thể bỏ dòng dưới
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              // object-fit: cover
              const r = Math.max(w / img.naturalWidth, h / img.naturalHeight);
              const nw = img.naturalWidth * r, nh = img.naturalHeight * r;
              const dx = (w - nw) / 2, dy = (h - nh) / 2;
              ctx.clearRect(0, 0, w, h);
              ctx.drawImage(img, dx, dy, nw, nh);
              resolve(canvas.toDataURL('image/png'));
            } catch (e) { reject(e); }
          };
          img.onerror = reject;
          img.src = src;
        });
      }

      function buildCard(item, kw) {
        const card = document.createElement('a');
        card.className = 'card';
        card.href = item.href; card.rel = 'nofollow'; card.draggable = false;

        const fav = document.createElement('div');
        fav.className = 'fav';

        const ico = document.createElement('img');
        ico.alt = '';
        ico.decoding = 'async';
        ico.loading = 'lazy';

        // Nguồn icon: ưu tiên data-icon, fallback favicon snapshot
        const customIcon = item.icon || '';
        const guess = customIcon || guessFavicon(item.href) || '';

        // Nhận diện file có thể động
        const looksAnimated = /\.(gif|webp)$/i.test(guess);

        if (guess) {
          if (looksAnimated) {
            // Hiển thị tạm chữ cái trong lúc tạo thumbnail
            fav.appendChild(makeLetterIcon(item.title?.[0]));

            generateStaticPreview(guess, 46, 46)
              .then(staticUrl => {
                // Lúc này có thumbnail tĩnh, thay vào IMG
                fav.innerHTML = '';
                ico.src = staticUrl;
                ico.dataset.static = staticUrl;
                ico.dataset.animated = guess;
                fav.appendChild(ico);

                // Chỉ chạy động khi hover card
                card.addEventListener('mouseenter', () => {
                  if (ico.dataset.animated) ico.src = ico.dataset.animated;
                });
                card.addEventListener('mouseleave', () => {
                  if (ico.dataset.static) ico.src = ico.dataset.static;
                });
              })
              .catch(() => {
                // Nếu tạo thumbnail lỗi -> dùng ảnh gốc (có thể động)
                fav.innerHTML = '';
                ico.src = guess;
                fav.appendChild(ico);
              });
          } else {
            ico.src = guess;
            ico.onerror = () => {
              fav.innerHTML = '';
              fav.appendChild(makeLetterIcon(item.title?.[0]));
            };
            fav.appendChild(ico);
          }
        } else {
          fav.appendChild(makeLetterIcon(item.title?.[0]));
        }

        const meta = document.createElement('div'); meta.className = 'meta';
        const h = document.createElement('h3'); h.className = 'title nebula-text';
        h.innerHTML = highlight(item.title || 'Không tiêu đề', kw);

        const note = document.createElement('div'); note.className = 'note';
        if (item.note) note.textContent = item.note;

        const badges = document.createElement('div'); badges.className = 'badges';
        (item.tags || []).forEach(t => {
          const b = document.createElement('span'); b.className = 'badge'; b.textContent = t;
          badges.appendChild(b);
        });

        meta.appendChild(h);
        if (item.note) meta.appendChild(note);
        meta.appendChild(badges);

        card.appendChild(fav);
        card.appendChild(meta);
        return card;
      }

      function setupKeyboardNav() {
        const links = $$('#cards .card');
        let idx = -1;
        function focusAt(i) { if (i < 0 || i >= links.length) return; idx = i; links[idx].focus(); }
        cards.onkeydown = (e) => {
          if (e.key === 'ArrowDown') { e.preventDefault(); focusAt(Math.min(idx + 1, links.length - 1)); }
          if (e.key === 'ArrowUp') { e.preventDefault(); focusAt(Math.max(idx - 1, 0)); }
          if (e.key === 'Enter' && idx >= 0) { links[idx].click(); }
        };
      }
      function render(items, kw = '') {
        cards.innerHTML = '';
        if (!items.length) {
          empty.style.display = 'block';
          chip.textContent = '0 site';
          return;
        }
        empty.style.display = 'none';
        const frag = document.createDocumentFragment();

        items.forEach(item => {
          const card = document.createElement('a');
          card.className = 'card';
          card.href = item.href;
          card.rel = 'nofollow';
          card.draggable = false;

          const fav = document.createElement('div');
          fav.className = 'fav';
          const ico = document.createElement('img');
          ico.alt = '';
          ico.decoding = 'async';
          ico.loading = 'lazy';

          // Nếu có icon tùy chỉnh
          const customIcon = item.icon || '';
          const guess = customIcon || guessFavicon(item.href) || '';
          if (guess) {
            ico.src = guess;
            ico.onerror = () => {
              fav.innerHTML = '';
              fav.appendChild(makeLetterIcon(item.title?.[0]));
            };
            fav.appendChild(ico);
          } else {
            fav.appendChild(makeLetterIcon(item.title?.[0]));
          }

          const meta = document.createElement('div');
          meta.className = 'meta';

          const h = document.createElement('h3');
          h.className = 'title nebula-text';
          h.innerHTML = highlight(item.title || 'Không tiêu đề', kw);

          const note = document.createElement('div');
          note.className = 'note';
          if (item.note) note.textContent = item.note;

          const badges = document.createElement('div');
          badges.className = 'badges';
          (item.tags || []).forEach(t => {
            const b = document.createElement('span');
            b.className = 'badge';
            b.textContent = t;
            badges.appendChild(b);
          });

          // Không còn phần actions, chỉ hiển thị meta và fav
          meta.appendChild(h);
          if (item.note) meta.appendChild(note);
          meta.appendChild(badges);

          card.appendChild(fav);
          card.appendChild(meta);
          frag.appendChild(card);
        });

        cards.appendChild(frag);
        chip.textContent = items.length + (items.length > 1 ? ' sites' : ' site');
      }
      function applyFilter() {
        const kw = norm(q.value);
        let items = data.filter(d => {
          const inKw = !kw || d.titleNorm.includes(kw) || d.noteNorm.includes(kw) || d.tagsNorm.some(t => t.includes(kw));
          const inTag = !activeTag || d.tags.includes(activeTag);
          return inKw && inTag;
        });

        // … phần sort & render giữ nguyên
        items.sort((a, b) => {
          const va = (a.tags.find(t => /^v[0-9.]/i.test(t)) || '').slice(1);
          const vb = (b.tags.find(t => /^v[0-9.]/i.test(t)) || '').slice(1);
          if (va && vb && va !== vb) {
            const pa = va.split(/[^\d]+/).map(n => parseInt(n || '0'));
            const pb = vb.split(/[^\d]+/).map(n => parseInt(n || '0'));
            for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
              const da = pa[i] || 0, db = pb[i] || 0;
              if (da !== db) return db - da;
            }
          }
          return a.title.localeCompare(b.title, 'vi');
        });
        renderChunked(items, kw);
      }

      // Shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== q) {
          e.preventDefault(); q.focus(); q.select();
        }
        if (e.key === 'Escape') {
          if (q.value) { q.value = ''; applyFilter(); }
          else q.blur();
        }
      });
      function debounce(fn, ms = 120) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }
      q.addEventListener('input', debounce(applyFilter, 120));

      // First render
      applyFilter();
      const brand = document.querySelector('.brand');
      const logo = brand?.querySelector('.logo');
      if (!brand || !logo) return;

      // Lấy đường dẫn từ data-icon
      const src = brand.getAttribute('data-icon');
      if (!src) return;

      // Xóa chữ cũ, thay bằng ảnh
      logo.innerHTML = '';
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Logo';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.borderRadius = 'inherit';

      img.onerror = () => { // fallback nếu ảnh lỗi
        logo.textContent = 'LM';
      };

      logo.appendChild(img);
    })();
    (function () {

    })();
    (function () {
      const LINK_ID = 'site-favicon';
      const LS_KEY = 'nebulae_site_favicon_v1';

      function ensureLink() {
        let l = document.getElementById(LINK_ID);
        if (!l) {
          l = document.createElement('link');
          l.id = LINK_ID;
          l.rel = 'icon';
          document.head.appendChild(l);
        }
        return l;
      }

      function guessType(url) {
        const ext = (url.split('?')[0].match(/\.(ico|png|jpg|jpeg|gif|webp|svg)$/i) || [, 'png'])[1].toLowerCase();
        return ({
          ico: 'image/x-icon',
          png: 'image/png',
          jpg: 'image/jpeg',
          jpeg: 'image/jpeg',
          gif: 'image/gif',
          webp: 'image/webp',
          svg: 'image/svg+xml'
        })[ext] || 'image/png';
      }

      function setFav(href) {
        if (!href) return;
        const l = ensureLink();
        l.type = guessType(href);
        l.href = href;
      }

      // Nguồn ưu tiên: ?favicon=... > <meta name="site-favicon"> > localStorage
      const qs = new URLSearchParams(location.search);
      const qIcon = qs.get('favicon');
      const mIcon = (document.querySelector('meta[name="site-favicon"]') || {}).content || '';
      const lsIcon = localStorage.getItem(LS_KEY) || '';

      const src = qIcon || mIcon || lsIcon;
      if (src) setFav(src);

      // API công khai: gọi từ console hoặc code khác
      window.setSiteFavicon = function (href) {
        if (typeof href === 'string' && href.trim()) {
          localStorage.setItem(LS_KEY, href.trim());
          setFav(href.trim());
        }
      };
      window.clearSiteFavicon = function () {
        localStorage.removeItem(LS_KEY);
        // không xoá <link>, chỉ ngừng ghi đè (bạn có thể set lại mặc định nếu muốn)
      };
    })();
    (function () {
      const brand = document.querySelector('.brand');
      const logoIcon = brand?.getAttribute('data-icon');
      if (logoIcon && window.setSiteFavicon) setSiteFavicon(logoIcon);
    })();
  </script>
</body>

</html>